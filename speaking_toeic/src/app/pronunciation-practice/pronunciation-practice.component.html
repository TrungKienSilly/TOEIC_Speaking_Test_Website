<!-- pronunciation-practice.component.html -->
<!-- Header -->
<section class="header">
  <div class="container">
    <div class="header-left">
      <div class="logo">
        <img src="/assets/img/logo.png" alt="Logo" class="logo-image" (error)="onImageError($event, 'logo')">
        <div class="brand-text">
          <div class="brand-name">TOEIC Mentors</div>
          <div class="brand-subtitle">Online Testing System</div>
        </div>
      </div>
    </div>

    <div class="header-center">
      <nav class="header-nav">
        <button class="nav-item active">
          <span class="nav-icon icon-practice"></span>
          <span>Luy·ªán t·∫≠p</span>
        </button>
        <button class="nav-item">
          <span class="nav-icon icon-roadmap"></span>
          <span>L·ªô tr√¨nh 600+</span>
        </button>
        <button class="nav-item">
          <span class="nav-icon icon-test"></span>
          <span>Thi th·ª≠</span>
        </button>
      </nav>
    </div>

    <div class="header-right">
      <button class="primary-action" (click)="goBack()">V√†o h·ªçc</button>
      <div class="header-divider"></div>
      <div class="user-info">
        <div class="user-flag">üáªüá≥</div>
        <span class="user-tier">BASIC</span>
        <div class="user-avatar">
          <img src="/assets/img/avatar.png" alt="Avatar" (error)="onImageError($event, 'avatar')">
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Debug info -->
<!-- <div *ngIf="allTopics().length > 0" style="position: fixed; top: 200px; right: 10px; background: yellow; padding: 15px; z-index: 9999; font-size: 14px; max-width: 300px;">
  <div><strong>DEBUG INFO:</strong></div>
  <div>Topics: {{ allTopics().length }}</div>
  <div>Current Topic: {{ currentTopic()?.name || 'NULL' }}</div>
  <div>Current Words: {{ currentWords().length }}</div>
  <div>Topic Index: {{ currentTopicIndex() }}</div>
  <div>Lesson Index: {{ currentLessonIndex() }}</div>
</div> -->

<div class="speaking-layout" *ngIf="currentTopic() && currentWords().length > 0">
  <aside class="left-menu">
    <div class="back-button-wrapper">
      <button class="back-button" (click)="goBack()">
        ‚Üê Tr·ªü v·ªÅ
      </button>
    </div>

    <div class="menu-group">
      <div class="menu-group-title">Ch·ªß ƒë·ªÅ</div>
      <div class="topic-list">
        @for (topic of allTopics(); track topic.name; let i = $index) {
          <button
            class="vowel-item"
            [class.active]="i === currentTopicIndex()"
            (click)="selectTopic(i)">
            {{ getTopicDisplayName(topic) }}
          </button>
        }
      </div>
    </div>

  </aside>

  <section class="flashcard-panel" *ngIf="getCurrentWord() as current">
    <div class="flashcard word-mode">
      <h2 class="word-title">
        <ng-container *ngIf="getWorstPhonemeLabel() as worst">
          {{ current.word }}
        </ng-container>
        <ng-container *ngIf="!getWorstPhonemeLabel()">
          {{ current.word }}
        </ng-container>
      </h2>
      <div class="word-meaning">{{ current.translation }}</div>

      <div class="pronunciation-buttons">
        <button class="pronunciation-btn us-btn" (click)="playAudio('us')" [class.playing]="isPlayingUS()">
          <img src="/assets/img/loa.png" alt="US" class="speaker-icon" (error)="onImageError($event, 'us')">
          US
        </button>
        <button class="pronunciation-btn uk-btn" (click)="playAudio('uk')" [class.playing]="isPlayingUK()">
          <img src="/assets/img/loa.png" alt="UK" class="speaker-icon" (error)="onImageError($event, 'uk')">
          UK
        </button>
      </div>

      <div class="phonetic-line">{{ current.ipa }}</div>

      <div class="recording-section">
        <button class="record-btn"
                [class.preparing]="isPreparing()"
                [class.recording]="isRecording()"
                [class.processing]="isProcessing()"
                (click)="startRecording()">
          <img src="/assets/img/mic-white.png" alt="Microphone" class="mic-icon" *ngIf="!isPreparing() && !isRecording() && !isProcessing()" (error)="onMicImageError($event)">
          <img src="/assets/img/songam.png" alt="Waveform" class="waveform-icon" *ngIf="isRecording()">
        </button>
        <div class="recording-text" *ngIf="isRecording() && !readyMessage()">ƒêang ghi l·∫°i √¢m thanh.. 5s</div>
        <div class="ready-recording-text" 
             [class.preparing-text]="isPreparing()"
             [class.recording-active-text]="isRecording()"
             *ngIf="readyMessage()">{{ readyMessage() }}</div>
        <div class="processing-text" *ngIf="!isPreparing() && !isRecording() && isProcessing()">ƒêang x·ª≠ l√Ω...</div>
        <div class="ready-text" *ngIf="!isPreparing() && !isRecording() && !isProcessing() && !showScore() && !readyMessage()">
          {{ hasMicPermission() ? 'Nh·∫•n v√†o ƒë·ªÉ ghi √¢m' : 'Nh·∫•n ƒë·ªÉ c·∫•p quy·ªÅn microphone' }}
        </div>
      </div>

      <div class="score-section" *ngIf="showScore()">
        <div class="score-header">
          <span class="score-emoji">üéØ</span>
          <span class="score-value">{{ currentScore.overall }}</span>
          <span class="score-emoji">üéØ</span>
        </div>

        <div class="score-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="currentScore.overall"></div>
          </div>
        </div>

        <button class="details-btn" (click)="toggleScoreDetails()">
          Chi ti·∫øt ph√°t √¢m
          <span class="dropdown-icon" [class.rotated]="showScoreDetails()">‚ñº</span>
        </button>
        <!-- c√¢u nh·∫≠n x√©t cho m·ªói m·ª©c ƒë·ªô ƒëi·ªÉm -->
        <div class="score-feedback">
          <span class="feedback-text">{{ overallFeedback }}</span>
        </div>
      </div>

      <div class="phoneme-details" *ngIf="showScoreDetails()">
        <div class="phoneme-metrics">
          <div class="metric-item">
            <span class="metric-label">ƒê·ªô ch√≠nh x√°c</span>
            <span class="metric-value" [class]="getScoreColor(currentScore.accuracy)">{{ currentScore.accuracy }}/100</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">ƒê·ªô ho√†n ch·ªânh</span>
            <span class="metric-value" [class]="getScoreColor(currentScore.completeness)">{{ currentScore.completeness }}/100</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">ƒê·ªô tr√¥i ch·∫£y</span>
            <span class="metric-value" [class]="getScoreColor(currentScore.fluency)">{{ currentScore.fluency }}/100</span>
          </div>
        </div>

        <div class="phoneme-card">
          <div class="phoneme-card__header">Chi ti·∫øt ph√°t √¢m</div>
          <table class="phoneme-card__table">
            <tbody>
            @for (phoneme of getPhonemeBreakdown(); track phoneme.phoneme) {
              <tr [class.worst]="isWorstPhoneme(phoneme)" [class.no-data]="!phoneme.hasData">
                <td class="phoneme-card__symbol">
                  <span class="symbol-text">{{ phoneme.phoneme }}</span>
                  <span class="symbol-score">[{{ phoneme.score }}/100]</span>
                </td>
                <td class="phoneme-card__status">
                  @if (phoneme.hasData) {
                    <span class="status-text">{{ getPhonemeFeedback(phoneme) }}</span>
                  } @else {
                    <span class="status-text">"Kh√¥ng c√≥ d·ªØ li·ªáu"</span>
                  }
                </td>
              </tr>
            }
            </tbody>
          </table>
          @if (hasUndetectedPhonemes()) {
            <div class="phoneme-card__summary">
              <strong>"Kh√¥ng c√≥ d·ªØ li·ªáu"</strong>
            </div>
          }
        </div>
      </div>

      <div class="bottom-navigation">
        <button class="nav-btn prev-btn" (click)="navigateLesson('prev')">
          <span class="nav-icon">‚Äπ</span>
        </button>
        <button class="nav-btn next-btn" (click)="navigateLesson('next')">
          <span class="nav-icon">‚Ä∫</span>
        </button>
      </div>
    </div>
  </section>

  <aside class="right-words">
    <div class="menu-group">
      <div class="menu-group-title">T·ª´ v·ª±ng</div>
      <div class="word-list">
        @for (word of currentWords(); track word.word; let i = $index) {
          <div class="word-item"
               [class.active]="i === currentLessonIndex()"
               (click)="selectWord(i)">
            <div class="word-content">
              <div class="w-term">{{ word.word }}</div>
              <div class="w-ipa">{{ word.ipa }}</div>
            </div>
          </div>
        }
      </div>
    </div>
  </aside>
</div>

<div class="empty-state" *ngIf="!currentTopic() || currentWords().length === 0">
  <p>ƒêang t·∫£i d·ªØ li·ªáu pronunciation...</p>
  <p style="font-size: 14px; color: #999;">Topics: {{ allTopics().length }}</p>
  <p style="font-size: 14px; color: #999;">Current Topic: {{ currentTopic()?.name || 'NULL' }}</p>
  <p style="font-size: 14px; color: #999;">Words: {{ currentWords().length }}</p>
</div>
