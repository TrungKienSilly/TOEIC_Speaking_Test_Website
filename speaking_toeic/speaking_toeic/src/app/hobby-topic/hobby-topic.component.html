<section class="header">
  <div class="container">
    <div class="header-left">
      <div class="logo">
        <img src="/assets/img/logo.png" alt="Logo" class="logo-image" (error)="onImageError($event, 'logo')">
        <img src="/assets/img/VN-2-1024x512.png" alt="TOEIC Mentors" class="logo-text-image" (error)="onImageError($event, 'text')">
        <!-- Fallback text if images don't load -->
      </div>
    </div>

    <div class="header-center">
      <div class="learning-btn active">
        <i class="icon-document"></i>
        Luy·ªán t·∫≠p
      </div>
    </div>

    <div class="header-right">
      <button class="btn-primary" (click)="goBack()">Trang ch·ªß</button>
    </div>
  </div>
</section>

<!-- Back Button -->
<button class="back-button" (click)="goBack()">
  ‚Üê Tr·ªü v·ªÅ
</button>

<div class="speaking-layout">
  <!-- Left Menu -->
  <aside class="left-menu">
    <div class="menu-group">
      <div class="menu-group-title">{{ getCurrentTopicName() }}</div>

      <!-- Danh s√°ch nguy√™n √¢m ƒë·ªÉ l·ªçc -->
      <div class="vowel-filter-section">
        <div class="vowel-list">
          <button
            class="vowel-item"
            [class.active]="activeVowel() === 'all'"
            (click)="filterByVowel('all')">
            T·∫•t c·∫£ ({{ lessons.length }})
          </button>
          @for(vowel of getAvailableVowels(); track vowel.code) {
            <button
              class="vowel-item"
              [class.active]="activeVowel() === vowel.code"
              (click)="filterByVowel(vowel.code)">
              {{ vowel.label }} ({{ vowel.count }})
            </button>
          }
        </div>
      </div>
    </div>
  </aside>

  <!-- Center Flashcard Panel -->
  <section class="flashcard-panel" *ngIf="getCurrentLesson()">
    <div class="flashcard word-mode">
      <h2 class="word-title">{{ getCurrentLesson().english }}</h2>
      <div class="word-meaning">{{ getCurrentLesson().vietnamese }}</div>

      <div class="pronunciation-buttons">
        <button class="pronunciation-btn us-btn" (click)="playAudio('us')" [class.playing]="isPlayingUS()">
          <img src="/assets/img/loa.png" alt="US" class="speaker-icon" (error)="onImageError($event, 'us')">
          US
        </button>
        <button class="pronunciation-btn uk-btn" (click)="playAudio('uk')" [class.playing]="isPlayingUK()">
          <img src="/assets/img/loa.png" alt="UK" class="speaker-icon" (error)="onImageError($event, 'uk')">
          UK
        </button>
      </div>

      <div class="phonetic-line">{{ getCurrentLesson().phonetic }}</div>

      <div class="recording-section">
        <button class="record-btn"
                [class.recording]="isRecording()"
                [class.processing]="isProcessing()"
                (click)="startRecording()">
          <img src="/assets/img/mic-white.png" alt="Microphone" class="mic-icon" *ngIf="!isRecording() && !isProcessing()" (error)="onMicImageError($event)">
          <span class="waveform-icon" *ngIf="isRecording()">„Ä∞</span>
          <span class="processing-icon" *ngIf="isProcessing()">‚è≥</span>
        </button>
        <div class="recording-text" *ngIf="isRecording()">ƒêang ghi l·∫°i √¢m thanh.. 5s</div>
        <div class="processing-text" *ngIf="isProcessing()">ƒêang x·ª≠ l√Ω...</div>
        <div class="ready-text" *ngIf="!isRecording() && !isProcessing() && !showScore()">Nh·∫•n v√†o ƒë·ªÉ n√≥i</div>
      </div>

      <!-- Score Display Section -->
      <div class="score-section" *ngIf="showScore()">
        <div class="score-header">
          <span class="score-emoji">üéØ</span>
          <span class="score-value">{{ currentScore.overall }}</span>
          <span class="score-emoji">üéØ</span>
        </div>

        <div class="score-progress">
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="currentScore.overall"></div>
          </div>
        </div>

        <button class="details-btn" (click)="toggleScoreDetails()">
          Chi ti·∫øt ph√°t √¢m
          <span class="dropdown-icon" [class.rotated]="showScoreDetails()">‚ñº</span>
        </button>

        <div class="score-feedback">
          <span class="feedback-text">Wow, ƒëi·ªÉm s·ªë ·∫•n t∆∞·ª£ng ƒë·∫•y, c√≥ b·ª©c ph√° th√™m x√≠u n√†o!</span>
        </div>
      </div>

      <!-- Detailed Phoneme Breakdown -->
      <div class="phoneme-details" *ngIf="showScoreDetails()">
        <!-- Overall Metrics -->
        <div class="overall-metrics">
          <div class="metric-item">
            <span class="metric-label">ƒê·ªô ch√≠nh x√°c:</span>
            <span class="metric-value" [class]="getScoreColor(currentScore.accuracy)">{{ currentScore.accuracy }}/100</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">ƒê·ªô ho√†n ch·ªânh:</span>
            <span class="metric-value" [class]="getScoreColor(currentScore.completeness)">{{ currentScore.completeness }}/100</span>
          </div>
          <div class="metric-item">
            <span class="metric-label">ƒê·ªô tr√¥i ch·∫£y:</span>
            <span class="metric-value" [class]="getScoreColor(currentScore.fluency)">{{ currentScore.fluency }}/100</span>
          </div>
        </div>

        <!-- Syllable Breakdown -->
        <div class="syllable-title">Chi ti·∫øt t·ª´ng √¢m ti·∫øt:</div>
        @for (phoneme of getPhonemeBreakdown(); track phoneme.phoneme) {
          <div class="phoneme-item">
            @if (phoneme.hasData) {
              <span class="phoneme-text" [class]="phoneme.color">{{ phoneme.phoneme }}</span>
              <span class="phoneme-score" [class]="phoneme.color">[{{ phoneme.score }}/100]</span>
              <span class="phoneme-feedback">
                @if (phoneme.score >= 80) {
                  <span class="feedback-icon">‚úì</span> ({{ phoneme.score }})
                } @else if (phoneme.score >= 60) {
                  <span class="feedback-icon">‚ñ≥</span> ({{ phoneme.score }})
                } @else {
                  <span class="feedback-icon">‚úó</span> ({{ phoneme.score }})
                }
              </span>
            } @else {
              <span class="phoneme-text no-data">{{ phoneme.phoneme }}</span>
              <span class="phoneme-score no-data">"Kh√¥ng c√≥ d·ªØ li·ªáu"</span>
              <span class="phoneme-feedback">
                <span class="feedback-icon">-</span> Kh√¥ng ph√°t hi·ªán
              </span>
            }
          </div>
        }
        @if (hasUndetectedPhonemes()) {
          <div class="phoneme-summary">
            <strong>"Kh√¥ng c√≥ d·ªØ li·ªáu"</strong>
          </div>
        }
      </div>

      <!-- Bottom Navigation -->
      <div class="bottom-navigation">
        <button class="nav-btn prev-btn" (click)="navigateLesson('prev')" [disabled]="currentLessonIndex() === 0">
          <span class="nav-icon">‚Äπ</span>
        </button>
        <button class="nav-btn next-btn" (click)="navigateLesson('next')" [disabled]="currentLessonIndex() >= lessons.length - 1">
          <span class="nav-icon">‚Ä∫</span>
        </button>
      </div>
    </div>
  </section>

  <!-- Right Word list -->
  <aside class="right-words">
    <div class="menu-group">
      <div class="menu-group-title">T·ª´ v·ª±ng</div>
      <div class="word-list">
        @for (lesson of sidebarLessons; track lesson.id) {
          <div class="word-item" [class.active]="lesson.id === getCurrentLesson()?.id">
            <div class="word-content">
              <div class="w-term">{{ lesson.english }}</div>
              <div class="w-ipa">{{ lesson.phonetic }}</div>
            </div>
          </div>
        }
      </div>
    </div>
  </aside>
</div>
