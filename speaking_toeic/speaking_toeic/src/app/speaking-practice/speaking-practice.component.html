<!-- Header -->
<header class="header">
  <div class="container">
    <div class="header-left">
      <div class="logo">
        <img src="/assets/img/logo.png" alt="Logo" class="logo-image" (error)="onImageError($event, 'logo')">
        <img src="/assets/img/VN-2-1024x512.png" alt="TOEIC Mentors" class="logo-text-image" (error)="onImageError($event, 'text')">
        <!-- Fallback text if images don't load -->
      </div>
    </div>
    
    <div class="header-center">
      <button class="learning-btn active">
        <i class="icon-document">üìÑ</i>
        H·ªçc c∆° b·∫£n
      </button>
      <button class="learning-btn">
        <i class="icon-book">üìñ</i>
        H·ªçc n√¢ng cao
      </button>
    </div>
    
    <div class="header-right">
      <button class="btn-primary">V√†o h·ªçc</button>
      <div class="user-profile">
        <i class="profile-icon">üë§</i>
      </div>
    </div>
  </div>
</header>

<!-- Main Content -->
<main class="main-content">
  <div class="container">
  
    <!-- Back Button -->
    <button class="back-button" (click)="goBack()">
      Tr·ªü v·ªÅ
    </button>

    <div class="speaking-layout">
      <!-- Left Menu -->
      <aside class="left-menu">
        <div class="menu-group">
          <div class="menu-group-title">{{ getCurrentTopicName() }}</div>
              
          <!-- Danh s√°ch nguy√™n √¢m ƒë·ªÉ l·ªçc -->
          <div class="vowel-filter-section">
            <div class="vowel-list">
              <button 
                class="vowel-item" 
                [class.active]="activeVowel() === 'all'"
                (click)="filterByVowel('all')">
                T·∫•t c·∫£ ({{ lessons.length }})
              </button>
              @for(vowel of getAvailableVowels(); track vowel.code) {
                <button 
                  class="vowel-item" 
                  [class.active]="activeVowel() === vowel.code"
                  (click)="filterByVowel(vowel.code)">
                  {{ vowel.label }} ({{ vowel.count }})
                </button>
              }
            </div>
          </div>
          
          <!-- Danh s√°ch Days ch·ªâ hi·ªÉn th·ªã khi kh√¥ng c√≥ topic -->
          <div class="day-list" *ngIf="!activeTopic()">
            @for(day of days; track day.vowel) {
              <button 
                class="day-item" 
                [class.active]="activeVowel() === day.vowel"
                (click)="selectVowel(day.vowel)">
                {{ day.label }}
              </button>
            }
          </div>
        </div>
      </aside>

      <!-- Center Flashcard Panel -->
      <section class="flashcard-panel" *ngIf="getCurrentLesson()">
        <div class="flashcard word-mode">
          <h2 class="word-title">{{ getCurrentLesson().english }}</h2>
          <div class="word-meaning">{{ getCurrentLesson().vietnamese }}</div>
          
          <div class="pronunciation-buttons">
            <button class="pronunciation-btn us-btn" 
                    [class.playing]="isPlayingUS()"
                    (click)="playAudio('us')">
              <img src="/assets/img/loa.png" alt="Speaker" class="speaker-icon">
              <span class="label">US</span>
            </button>
            <button class="pronunciation-btn uk-btn" 
                    [class.playing]="isPlayingUK()"
                    (click)="playAudio('uk')">
              <img src="/assets/img/loa.png" alt="Speaker" class="speaker-icon">
              <span class="label">UK</span>
            </button>
          </div>

          <div class="phonetic-line">{{ getCurrentLesson().phonetic }}</div>

          <!-- Score Display Section -->
          <div class="score-section" *ngIf="showScore()">
            <div class="score-header">
              <span class="score-value">{{ currentScore.overall }}/100</span>
              <span class="score-emoji">üòä</span>
            </div>
            <div class="score-progress">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="currentScore.overall"></div>
              </div>
            </div>
            <div class="score-details">
              <button class="details-btn" (click)="toggleScoreDetails()">
                Chi ti·∫øt ph√°t √¢m
                <span class="dropdown-icon" [class.rotated]="showScoreDetails()">‚ñº</span>
              </button>
            </div>
            
            <!-- Detailed Phoneme Breakdown -->
            <div class="phoneme-details" *ngIf="showScoreDetails()">
              <!-- Overall Metrics -->
              <div class="overall-metrics">
                <div class="metric-item">
                  <span class="metric-label">ƒê·ªô ch√≠nh x√°c:</span>
                  <span class="metric-value" [class]="getScoreColor(currentScore.accuracy)">{{ currentScore.accuracy }}/100</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">ƒê·ªô ho√†n ch·ªânh:</span>
                  <span class="metric-value" [class]="getScoreColor(currentScore.completeness)">{{ currentScore.completeness }}/100</span>
                </div>
                <div class="metric-item">
                  <span class="metric-label">ƒê·ªô tr√¥i ch·∫£y:</span>
                  <span class="metric-value" [class]="getScoreColor(currentScore.fluency)">{{ currentScore.fluency }}/100</span>
                </div>
              </div>
              
              <!-- Syllable Breakdown -->
              <div class="syllable-title">Chi ti·∫øt t·ª´ng √¢m ti·∫øt:</div>
              @for (phoneme of getPhonemeBreakdown(); track phoneme.phoneme) {
                <div class="phoneme-item">
                  @if (phoneme.hasData) {
                    <span class="phoneme-text" [class]="phoneme.color">{{ phoneme.phoneme }}</span>
                    <span class="phoneme-score" [class]="phoneme.color">[{{ phoneme.score }}/100]</span>
                    <span class="phoneme-feedback">
                      @if (phoneme.score >= 80) {
                        <span class="feedback-icon">‚úì</span> ({{ phoneme.score }})
                      } @else if (phoneme.score >= 60) {
                        <span class="feedback-icon">‚ñ≥</span> ({{ phoneme.score }})
                      } @else {
                        <span class="feedback-icon">‚úó</span> ({{ phoneme.score }})
                      }
                    </span>
                  } @else {
                    <span class="phoneme-text no-data">{{ phoneme.phoneme }}</span>
                    <span class="phoneme-score no-data">"Kh√¥ng c√≥ d·ªØ li·ªáu"</span>
                    <span class="phoneme-feedback">
                      <span class="feedback-icon">-</span> Kh√¥ng ph√°t hi·ªán
                    </span>
                  }
                </div>
              }
              @if (hasUndetectedPhonemes()) {
                <div class="phoneme-summary">
                  <strong>"Kh√¥ng c√≥ d·ªØ li·ªáu"</strong>
                </div>
              }
            </div>
            <div class="score-feedback">
              <span class="feedback-text">Wow, ƒëi·ªÉm s·ªë ·∫•n t∆∞·ª£ng ƒë·∫•y, c√≥ b·ª©c ph√° th√™m x√≠u n√†o!</span>
            </div>
          </div>

          <div class="recording-section">
            <button class="record-btn" 
                    [class.recording]="isRecording()" 
                    [class.processing]="isProcessing()"
                    (click)="startRecording()">
              <img src="/assets/img/mic-white.png" alt="Microphone" class="mic-icon" *ngIf="!isRecording() && !isProcessing()" (error)="onMicImageError($event)">
              <span class="waveform-icon" *ngIf="isRecording()">„Ä∞</span>
              <span class="processing-icon" *ngIf="isProcessing()">‚è≥</span>
            </button>
            <div class="recording-text" *ngIf="isRecording()">ƒêang ghi l·∫°i √¢m thanh.. 5s</div>
            <div class="processing-text" *ngIf="isProcessing()">ƒêang x·ª≠ l√Ω...</div>
            <div class="ready-text" *ngIf="!isRecording() && !isProcessing() && !showScore()">Nh·∫•n v√†o ƒë·ªÉ n√≥i</div>
          </div>
        </div>
      </section>

      <!-- Right Word List -->
      <aside class="right-words">
        @for (item of sidebarLessons; track item.id) {
          <div class="word-item" [class.active]="item.id === getCurrentLesson()?.id" (click)="currentLessonIndex.set(lessons.indexOf(item))">
            <div class="word-icon">üìÑ</div>
            <div class="word-content">
              <div class="w-term">{{ item.english }}</div>
              <div class="w-ipa">{{ item.phonetic }}</div>
            </div>
          </div>
        }
      </aside>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-navigation">
      <button class="nav-btn prev-btn" (click)="navigateLesson('prev')">
        <span class="nav-icon">‚óÄ</span>
      </button>
      <button class="nav-btn next-btn" (click)="navigateLesson('next')">
        <span class="nav-icon">‚ñ∂</span>
      </button>
    </div>
  </div>
</main>